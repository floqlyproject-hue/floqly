# Floqly — Полная техническая спецификация

> Документ создан на основе PRD v2.1 и результатов интервью с владельцем продукта.
> Дата: 2026-01-29

---

## 1. Обзор проекта

### 1.1 Что такое Floqly?

**Floqly** — это экосистема виджетов для сайтов, построенная по модели PLG (Product-Led Growth):

1. **Бесплатные инструменты** (Cookie Generator, Simple Widget) — точки входа для SEO-трафика
2. **Личный кабинет** — единый центр управления виджетами
3. **Умный виджет** — AI-ассистент для продаж, работающий 24/7

### 1.2 Бизнес-модель

| Тариф | Возможности | Цена |
|-------|-------------|------|
| Free | 3 сайта, лимит сообщений AI, брендинг Floqly | 0 ₽ |
| Pro | Безлимит, без брендинга, приоритетная поддержка | TBD |
| Enterprise | API, SLA, выделенный менеджер | TBD |

### 1.3 Целевая аудитория

| Персона | Потребность | Точка входа |
|---------|-------------|-------------|
| Веб-разработчик/Фрилансер | Быстро, бесплатно, красиво | Cookie Generator |
| Владелец малого бизнеса | "Магическая кнопка" для продаж | Simple Widget → Умный виджет |
| Маркетолог | Аналитика, вовлечение | Умный виджет + Dashboard |

---

## 2. Технологический стек

### 2.1 Frontend

| Технология | Версия | Назначение |
|------------|--------|------------|
| Next.js | 14+ | App Router, SSR для SEO, RSC |
| TypeScript | 5+ | Типизация |
| Tailwind CSS | 3+ | Стилизация |
| Framer Motion | 10+ | Анимации (MVP) |
| GSAP | 3+ | Сложные анимации |
| Three.js / React Three Fiber | — | WebGL (после MVP) |

### 2.2 Backend

| Технология | Назначение |
|------------|------------|
| Node.js + Express/Fastify | API сервер |
| Supabase | БД (PostgreSQL), Auth, Realtime, Storage |
| Redis | Кэширование, rate limiting (позже) |

### 2.3 Виджет (Embed Script)

| Технология | Назначение |
|------------|------------|
| Vanilla TypeScript | Минимальный размер bundle |
| Shadow DOM | Изоляция стилей от сайта клиента |
| Vite / esbuild | Быстрый билд |

**Требования к виджету:**
- Bundle size: < 50kb gzipped (функционал важнее, но не тормозить сайт)
- Загрузка: `defer` или `async`
- Изоляция: Shadow DOM обязателен
- Работа в iframe: Да (Tilda, Wix и т.д.)

### 2.4 Инфраструктура

| Компонент | Сервис |
|-----------|--------|
| Хостинг | Timeweb Cloud (Docker) |
| CDN виджета | cdn.floqly.ru |
| CI/CD | GitHub Actions |
| Error tracking | Sentry (free tier) |
| Аналитика | Yandex Метрика + Цели |
| Бэкапы | Ежедневные автоматические |

### 2.5 Внешние интеграции

| Интеграция | Тип | Статус |
|------------|-----|--------|
| AI-партнёр (Илья) | REST API | Уточнить детали |
| OAuth провайдеры | Yandex, VK, Google, Telegram, Email | MVP |
| CRM (AmoCRM, Bitrix24) | Webhook API | MVP |
| Telegram Bot | Уведомления владельцам | MVP |

---

## 3. Архитектура приложения

### 3.1 Монорепозиторий (предложение)

```
floqly/
├── apps/
│   ├── web/                 # Next.js приложение
│   │   ├── app/
│   │   │   ├── (marketing)/ # Главная, лендинги
│   │   │   ├── (dashboard)/ # Личный кабинет
│   │   │   ├── (tools)/     # Cookie Generator, Simple Widget конструктор
│   │   │   └── api/         # API routes
│   │   └── ...
│   ├── widget/              # Встраиваемый виджет
│   │   ├── src/
│   │   │   ├── core/        # Ядро виджета
│   │   │   ├── themes/      # 10+ скинов
│   │   │   ├── components/  # Launcher, Chat, Teaser
│   │   │   └── ...
│   │   └── ...
│   └── admin/               # Админ-панель (базовая)
├── packages/
│   ├── ui/                  # Общие UI компоненты
│   ├── config/              # Shared конфиги (ESLint, TS, Tailwind)
│   ├── database/            # Supabase клиент, типы, миграции
│   └── analytics/           # Трекинг событий
├── design-references/       # Референсы дизайна от владельца
├── docs/                    # Документация, блог контент
└── ...
```

### 3.2 Структура базы данных

```sql
-- Пользователи (Supabase Auth)
users
  - id (uuid, PK)
  - email
  - created_at
  - subscription_tier (free/pro/enterprise)

-- Проекты (сайты)
projects
  - id (uuid, PK)
  - user_id (FK → users)
  - domain
  - name
  - created_at
  - settings (jsonb)

-- Виджеты
widgets
  - id (uuid, PK)
  - project_id (FK → projects)
  - type (cookie/simple/smart)
  - config (jsonb) -- цвета, позиция, тексты и т.д.
  - is_active
  - created_at
  - updated_at

-- Диалоги (для умного виджета)
conversations
  - id (uuid, PK)
  - widget_id (FK → widgets)
  - visitor_id (анонимный идентификатор)
  - started_at
  - ended_at
  - status (active/closed/handed_off)
  - metadata (jsonb) -- URL страницы, user agent и т.д.

-- Сообщения
messages
  - id (uuid, PK)
  - conversation_id (FK → conversations)
  - role (visitor/assistant/operator)
  - content (text)
  - attachments (jsonb) -- для будущего
  - created_at

-- База знаний (файлы для AI)
knowledge_base
  - id (uuid, PK)
  - project_id (FK → projects)
  - file_name
  - file_path (в storage)
  - file_type
  - status (pending/processing/ready/error)
  - created_at

-- Аналитика
analytics_events
  - id (uuid, PK)
  - widget_id (FK → widgets)
  - event_type (impression/open/message/conversion)
  - visitor_id
  - page_url
  - created_at
  - metadata (jsonb)

-- Заявки (callback формы, офлайн режим)
leads
  - id (uuid, PK)
  - widget_id (FK → widgets)
  - name
  - phone
  - email
  - message
  - source (callback_form/offline/handoff)
  - created_at
```

---

## 4. Функциональные требования

### 4.1 Cookie Generator

**Назначение:** SEO-приманка, точка входа в экосистему.

**Функционал:**
- [ ] Визуальный редактор плашки Cookie
- [ ] Настройки:
  - Положение: Bottom / Top / Floating
  - Цвета: Color Picker + пресеты
  - Текст: Редактируемый (поддержка HTML)
  - Ссылка на политику конфиденциальности
  - Срок скрытия после принятия (X дней)
  - Backdrop blur (размытие фона)
- [ ] Live Preview
- [ ] Compliance: Полный 152-ФЗ / GDPR
- [ ] Генерация кода: `<script src="cdn.floqly.ru/c.js?id=WIDGET_ID">`

**Воронка:**
1. Пользователь настраивает виджет
2. Нажимает "Получить код"
3. **Блокер:** Поп-ап "Сохраните в ЛК для редактирования без переустановки"
4. Регистрация / Вход
5. Виджет сохраняется, выдаётся код

### 4.2 Simple Widget (Конструктор кнопок)

**Назначение:** Бесплатный виджет с кнопками мессенджеров.

**Поддерживаемые каналы:**
- [ ] WhatsApp
- [ ] Telegram
- [ ] VK
- [ ] Viber
- [ ] Facebook Messenger
- [ ] Instagram Direct
- [ ] Телефон (tel:)
- [ ] Email (mailto:)
- [ ] Callback-форма (встроенная)

**Режимы отображения:**
- [ ] FAB с раскрывающимся меню (одна кнопка → клик → список)
- [ ] Несколько отдельных кнопок

**Настройки:**
- [ ] Выбор каналов и их порядок
- [ ] Позиция на экране (4 угла + кастомный offset)
- [ ] Цветовая схема
- [ ] Call-to-Action в "облачке"
- [ ] Анимация появления

### 4.3 Умный виджет (AI Chat)

**Назначение:** AI-ассистент по продажам, работающий 24/7.

#### 4.3.1 Компоненты виджета

**Launcher (Кнопка):**
- [ ] Круглая / Овальная форма
- [ ] Аватар / Логотип
- [ ] Анимация пульсации при непрочитанных
- [ ] Счётчик непрочитанных

**Teaser (Тизер):**
- [ ] Пузырёк с сообщением ДО открытия
- [ ] Режимы:
  - Статический (один текст на весь сайт)
  - Контекстный (разные тексты для разных URL)
  - AI-генерируемый (анализ страницы)
  - Отключён (не мешать пользователю)
- [ ] Настраиваемая задержка появления

**Main Container (Окно чата):**
- [ ] Header: Аватар, Имя, Кнопка закрытия, Меню (⋮)
- [ ] Body: Лента сообщений
  - Поддержка Markdown (списки, bold, italic, ссылки)
  - Quick Reply кнопки (chips)
  - Карточки товаров (фото, цена, кнопка)
  - Typing indicator ("Печатает...")
- [ ] Input Area: Поле ввода + отправка
- [ ] Footer: "Powered by Floqly" (на бесплатном)

#### 4.3.2 Поведение виджета

**Триггеры появления (настраиваемые):**
- [ ] Сразу при загрузке
- [ ] Через X секунд
- [ ] При скролле до Y%
- [ ] При попытке уйти (exit intent)
- [ ] Комбинация

**Офлайн-режим:**
- [ ] Если сервер недоступен → показать форму заявки
- [ ] Данные сохраняются локально и отправляются при восстановлении связи

**Сохранение истории:**
- [ ] localStorage для быстрого доступа
- [ ] Синхронизация с сервером (архитектура под это)
- [ ] Visitor ID через fingerprint или cookie

**Human Handoff:**
- [ ] Кнопка "Позвать оператора"
- [ ] Уведомление владельцу (Telegram bot)
- [ ] Статус "Ожидание оператора"

#### 4.3.3 Дизайн-система (10+ скинов)

Универсальная DOM-структура, смена темы через CSS-класс:

- [ ] Default (Floqly стиль)
- [ ] Dark Mode
- [ ] Строгий банк
- [ ] Игривый стартап
- [ ] Неоморфизм
- [ ] iOS Style
- [ ] WhatsApp Clone
- [ ] Minimal
- [ ] Glassmorphism
- [ ] Custom (полный контроль + CSS)

### 4.4 Личный кабинет (Dashboard)

**Структура:** `User → Projects (сайты) → Widgets`

#### 4.4.1 Разделы

**Overview:**
- [ ] Список проектов (сайтов)
- [ ] Статус виджетов (Активен / Не установлен / Ошибка)
- [ ] Быстрая статистика

**Редактор виджета:**
- [ ] Левая панель: Настройки (аккордеон)
- [ ] Правая панель: Live Preview виджета
- [ ] Будущее: Preview на фоне реального сайта (iframe / скриншот)

**Настройка Умного виджета:**
- [ ] Указание домена
- [ ] Drag & Drop загрузка файлов (PDF, DOCX, TXT)
- [ ] Поле "Tone of Voice" (формальный, дружелюбный, дерзкий)
- [ ] Статус-бар обработки: Загружено → Анализ → Готов

**История диалогов:**
- [ ] Список всех диалогов
- [ ] Фильтры: дата, статус, страница
- [ ] Просмотр конкретного диалога
- [ ] Экспорт: CSV / JSON

**Аналитика:**
- [ ] Показы виджета
- [ ] Открытия чата
- [ ] Количество сообщений
- [ ] Конверсии (лиды, callback)
- [ ] Графики по времени

**Настройки проекта:**
- [ ] Домен
- [ ] Команда (позже)
- [ ] Webhooks для CRM
- [ ] Telegram-бот подключение

**Настройки аккаунта:**
- [ ] Профиль
- [ ] Безопасность (2FA опционально)
- [ ] Тарифный план
- [ ] Экспорт всех данных

### 4.5 Главная страница (Marketing Site)

**Концепция:** "Живой сайт" — виджет как главный герой.

**Сценарий анимации (The Widget Journey):**
1. **Hero:** Виджет в центре, крупно. Демо-диалог.
2. **Scroll → Проблемы:** Виджет сжимается, следует за курсором.
3. **Секция Демо:** Виджет sticky в углу, смена скинов.
4. **CTA:** Виджет раскрывается в форму заявки.

**Технические требования:**
- [ ] GSAP / Framer Motion (MVP)
- [ ] Lenis Scroll для плавности
- [ ] WebGL / Three.js (после MVP)
- [ ] Debounce/Throttle для производительности
- [ ] Упрощённая версия для мобильных / слабых устройств

### 4.6 Блог и документация

- [ ] Markdown-based контент
- [ ] SEO-оптимизация
- [ ] Категории, теги
- [ ] Ключевые слова: нужно собрать семантическое ядро

### 4.7 Админ-панель (для команды Floqly)

**Базовый функционал:**
- [ ] Список пользователей
- [ ] Управление статусами AI-обработки
- [ ] Просмотр статистики
- [ ] Ручное управление тарифами

---

## 5. Нефункциональные требования

### 5.1 Производительность

| Метрика | Цель |
|---------|------|
| Widget Load Time | < 200ms |
| Widget Bundle Size | < 50kb gzipped |
| Dashboard LCP | < 2.5s |
| API Response Time | < 300ms (p95) |

### 5.2 Безопасность

- [ ] CORS: только разрешённые домены (из настроек проекта)
- [ ] JWT для API ЛК
- [ ] Rate limiting для публичных API
- [ ] Валидация всех входных данных
- [ ] XSS защита
- [ ] CSRF токены
- [ ] Не хранить чувствительные данные в localStorage

### 5.3 Совместимость

**Браузеры (только современные):**
- Chrome 90+
- Firefox 90+
- Safari 14+
- Edge 90+

**Особые требования:**
- [ ] Работа внутри iframe (Tilda, Wix, конструкторы)
- [ ] Не конфликтовать с популярными фреймворками (React, Vue, jQuery)
- [ ] Нейтральные имена классов/файлов (избежать AdBlock)

### 5.4 Доступность (Accessibility)

**Уровень: Базовый**
- [ ] Клавиатурная навигация
- [ ] Фокус-индикаторы
- [ ] aria-labels для интерактивных элементов
- [ ] Достаточный контраст текста

---

## 6. Интеграция с AI-партнёром

### 6.1 Текущее понимание

| Параметр | Значение |
|----------|----------|
| Партнёр | Илья |
| Язык | Python |
| Интеграция | REST API |
| Анализ контекста | Не определено (обсудить) |

### 6.2 Предполагаемый API

**Отправка сообщения:**
```
POST /api/v1/chat
{
  "widget_id": "uuid",
  "conversation_id": "uuid",
  "message": "Сколько стоит доставка?",
  "context": {
    "page_url": "https://example.com/delivery",
    "page_title": "Доставка",
    "page_content": "..." // или null, если партнёр сам парсит
  }
}

Response:
{
  "reply": "Доставка по Москве бесплатная при заказе от 3000₽...",
  "quick_replies": ["Оформить заказ", "Другой вопрос"],
  "products": [...] // карточки товаров, если релевантно
}
```

### 6.3 Открытые вопросы для партнёра

1. Кто анализирует контекст страницы — мы или партнёр?
2. Формат передачи базы знаний?
3. Streaming ответов (SSE) или только REST?
4. Rate limits?
5. Обработка ошибок?

---

## 7. Уведомления

### 7.1 Email

**Только для авторизации:**
- [ ] Подтверждение email
- [ ] Сброс пароля
- [ ] Magic link вход

### 7.2 Telegram Bot

**Уведомления владельцам сайтов:**
- [ ] Новый диалог начат
- [ ] Запрос на оператора (handoff)
- [ ] Новый лид (callback-форма)
- [ ] Лимит сообщений скоро закончится

**Подключение:**
- [ ] Генерация уникальной ссылки в ЛК
- [ ] Привязка Telegram аккаунта к проекту

---

## 8. План реализации (Roadmap)

### Фаза 1: Фундамент
- [ ] Настройка монорепозитория
- [ ] Настройка CI/CD
- [ ] Supabase: схема БД, миграции
- [ ] Авторизация (все провайдеры)
- [ ] Базовый UI-кит

### Фаза 2: Cookie Generator
- [ ] UI генератора
- [ ] Preview виджета
- [ ] Сохранение конфигурации
- [ ] Генерация embed-кода
- [ ] Воронка регистрации
- [ ] Embed-скрипт для Cookie

### Фаза 3: Simple Widget
- [ ] Конструктор кнопок
- [ ] FAB-меню
- [ ] Callback-форма
- [ ] Embed-скрипт

### Фаза 4: Личный кабинет
- [ ] Dashboard overview
- [ ] Редактор виджетов
- [ ] Базовая аналитика
- [ ] История диалогов (подготовка)

### Фаза 5: Умный виджет
- [ ] Ядро чат-виджета
- [ ] Интеграция с AI-партнёром
- [ ] Карточки товаров
- [ ] Human handoff
- [ ] Telegram-бот уведомления

### Фаза 6: Главная страница
- [ ] Лендинг с анимациями
- [ ] Демо-режим виджета
- [ ] SEO-оптимизация

### Фаза 7: Доработки
- [ ] Блог + документация
- [ ] Расширенная аналитика
- [ ] Экспорт данных
- [ ] Админ-панель
- [ ] WebGL анимации

---

## 9. Метрики успеха

| Метрика | Описание | Цель |
|---------|----------|------|
| CAC | Customer Acquisition Cost | 0 ₽ (органика) |
| Cookie Gen → Signup | Конверсия в регистрацию | > 10% |
| Signup → Widget Installed | Активация | > 30% |
| Widget Load Time | Время загрузки скрипта | < 200ms |
| NPS | Удовлетворённость | > 50 |

---

## 10. Риски и митигация

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| AdBlock блокирует виджет | Высокая | Нейтральные имена (fl-helper.js, не ad-widget.js) |
| Тяжёлые анимации | Средняя | Fallback для слабых устройств |
| Партнёр задерживает AI | Средняя | Запуск с Cookie + Simple, AI в waitlist |
| Клиент не умеет ставить код | Высокая | Плагины WP/Tilda, подробные инструкции |
| CORS/iframe проблемы | Средняя | Тестирование на популярных конструкторах |

---

## 11. Дополнительные уточнения (из интервью #2)

### 11.1 Управление проектами
- **Командная работа:** Позже (MVP — один владелец на проект)
- **Multi-domain:** Да, один виджет может работать на нескольких доменах (dev, staging, prod)
- **Клонирование виджета:** Да, возможность дублировать настройки

### 11.2 Лимиты и ограничения
- **При исчерпании лимита:** Настраивается в админке (отключение / форма / ограниченный режим)
- **Бан спамеров:** Да, нужно (по IP/fingerprint)

### 11.3 Аналитика и данные
- **Частота обновления:** Раз в час (агрегация)
- **Удаление аккаунта:** Обязательно (GDPR right to be forgotten)
- **Геолокация:** Позже
- **A/B тесты:** Позже

### 11.4 UX виджета
- **На мобильных:** Как на десктопе (адаптив, не fullscreen)
- **Сбор контактов AI:** Нет, только через форму
- **Рабочие часы:** Позже
- **Email транскрипт:** Нет, хватит Telegram

### 11.5 Шаблоны
- **Готовые пресеты для ниш:** Да (e-commerce, услуги, SaaS и т.д.)

---

## 12. Открытые вопросы

> Требуют обсуждения перед/во время разработки

1. **Брендинг:** Логотип, цветовая палитра, шрифты — нужно создать
2. **Тексты:** Копирайтинг для сайта — будут позже
3. **SEO:** Семантическое ядро для Cookie Generator — нужно собрать
4. **AI-интеграция:** Детали API с Ильёй — уточнить
5. **Ценообразование:** Конкретные цифры для тарифов — определить

---

## Приложения

### A. Конкуренты для анализа

- JivoChat (RU)
- Carrot Quest (RU)
- Intercom (US)
- Drift (US)
- Tawk.to (бесплатный)
- Crisp (EU)

### B. Референсы дизайна

Студии для вдохновения:
- Locomotive
- Cuberto
- Unseen Studio

Технологии:
- Lenis Scroll
- Three.js
- GSAP ScrollTrigger

**Цель:** Site of the Day на Awwwards (2026)

### C. Полезные ссылки

- [Supabase Docs](https://supabase.com/docs)
- [Next.js App Router](https://nextjs.org/docs/app)
- [Tailwind CSS](https://tailwindcss.com/docs)
- [Framer Motion](https://www.framer.com/motion/)
- [GSAP](https://greensock.com/docs/)

# План: Редизайн Step 4 — Визуальный редактор Cookie-баннера

## Проблема

Сейчас Step 4 сразу бросает пользователя в preview сайта с liquid-glass островом, где ВСЁ смешано: текст, стиль, позиция, анимация. Пользователь без опыта теряется — непонятно с чего начать и что настраивать.

## Решение

Разбить Step 4 на **два суб-таба** с переключателем вверху:

```
┌─────────────────────────────────────────────────────┐
│  Шаг 4. Оформление                                 │
│                                                     │
│  Подсказка: сначала настройте содержание баннера,   │
│  затем переключитесь на визуальный редактор         │
│                                                     │
│  ┌──────────────┐ ┌──────────────┐                  │
│  │ 📝 Содержание │ │ 🎨 Оформление│                  │
│  └──────────────┘ └──────────────┘                  │
└─────────────────────────────────────────────────────┘
```

---

## Суб-таб 1: «Содержание»

### Layout: две колонки

```
┌──────────────────────────┬──────────────────────────┐
│     НАСТРОЙКИ (слева)    │    ПРЕВЬЮ (справа)       │
│                          │                          │
│  ┌─ ТОН СООБЩЕНИЯ ────┐ │   Баннер на нейтральном  │
│  │ [Дружелюбный]       │ │   фоне (не preview       │
│  │ [Короткий]          │ │   сайта). Стиль          │
│  │ [Официальный]       │ │   синхронизирован        │
│  │ [Креативный]        │ │   с суб-табом            │
│  │ [Развёрнутый]       │ │   «Оформление»          │
│  └─────────────────────┘ │                          │
│                          │   ┌──────────────────┐   │
│  ┌─ КНОПКИ ───────────┐ │   │  🍪 Мы используем│   │
│  │ ☑ Отклонить  [текст]│ │   │  cookie          │   │
│  │ ☑ Настроить  [текст]│ │   │  Для удобства... │   │
│  │   Принять    [текст]│ │   │                  │   │
│  └─────────────────────┘ │   │ [Откл] [Настр]   │   │
│                          │   │        [Принять]  │   │
│  ┌─ ССЫЛКА НА ПОЛИТИКУ┐ │   └──────────────────┘   │
│  │ ☐ Слово в тексте    │ │                          │
│  │ ☐ Отдельная строка  │ │                          │
│  └─────────────────────┘ │                          │
│                          │                          │
│  ▸ Редактировать текст   │                          │
│    вручную (свернуто)    │                          │
│                          │                          │
└──────────────────────────┴──────────────────────────┘
```

### Детали элементов

#### 1. Тон сообщения
- **Формат:** Кнопки-сегменты (pill buttons) в 2 ряда, как сейчас в island text-panel
- **Поведение:** Клик → мгновенно обновляется баннер справа (заголовок, описание, тексты кнопок)
- **Варианты:** Дружелюбный, Короткий, Официальный, Креативный, Развёрнутый
- Данные берутся из существующего `TONE_TEXTS`

#### 2. Кнопки баннера
- **«Принять»** — всегда включена, только поле текста (по умолчанию «Принять»)
- **«Отклонить»** — toggle вкл/выкл + поле текста (по умолчанию «Отклонить»)
- **«Настроить»** — toggle вкл/выкл + поле текста (по умолчанию «Настроить»)
- При выключении toggle — кнопка исчезает из баннера в превью

#### 3. Ссылка на политику Cookie
Два варианта, можно включить оба:

**Вариант A — Слово-ссылка в тексте:**
- Toggle «Выделить слово в тексте как ссылку»
- При включении → под toggle появляется:
  - Поле «Слово-ссылка» (по умолчанию: «cookie» — первое вхождение слова из текста)
  - В баннере это слово подчёркивается и становится кликабельным
- Реализация: НЕ rich text editor. Просто поле ввода слова → находим его в тексте → оборачиваем в `<a>` при генерации

**Вариант Б — Отдельная строка:**
- Toggle «Показать ссылку "Подробнее"»
- При включении → под toggle появляется:
  - Поле «Текст ссылки» (по умолчанию: «Подробнее о cookie»)
  - Строка появляется под описанием в баннере

**Общие настройки ссылки (появляются если включён хотя бы один вариант):**
- Переключатель: «Документ в попапе» | «Ссылка на страницу»
  - **Документ в попапе:** При клике откроется всплывающее окно с полным текстом cookie-политики (генерируется на шаге 3)
  - **Ссылка на страницу:** Поле URL (placeholder: «https://site.com/cookie-policy»)
    - Подсказка: «Если страницы ещё нет — вы сможете создать её и добавить ссылку позже в личном кабинете»

#### 4. Ручное редактирование текста
- **По умолчанию свёрнуто** (кнопка «Редактировать текст вручную»)
- При раскрытии → 4 поля: Заголовок, Описание, и тексты кнопок (те же что есть, но сейчас в island)
- При ручном редактировании → тон переключается на «Свой» (кастомный) или текущий тон визуально сбрасывается
- Подсказка: «Изменения в тексте сохраняются. Если выбрать новый тон — текст обновится»

#### 5. Превью баннера справа
- Баннер на нейтральном фоне (светло-серый `bg-muted`)
- Стиль баннера синхронизирован с суб-табом «Оформление» (если пользователь выбрал glass → здесь тоже glass)
- При первом входе → classic белый (дефолт)
- Баннер обновляется **мгновенно** при любом изменении
- Без фона сайта, без скриншота — чистый фокус на тексте

---

## Суб-таб 2: «Оформление»

### Layout: полный текущий визуальный редактор

```
┌─────────────────────────────────────────────────────┐
│                                                     │
│  ┌─────────────────────────────────────────────┐    │
│  │            Browser Frame (preview)           │    │
│  │  ┌───────────────────────────────────────┐   │    │
│  │  │  screenshot / light / dark / custom   │   │    │
│  │  │                                       │   │    │
│  │  │                                       │   │    │
│  │  │         ┌─────────────────┐           │   │    │
│  │  │         │  Cookie баннер  │           │   │    │
│  │  │         └─────────────────┘           │   │    │
│  │  └───────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────┘    │
│                                                     │
│  🔧 Liquid Glass Island        🖼 Background Island │
│  (стиль, позиция, анимация)    (фон preview)       │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### Что меняется
- **Убрать Text Panel из island** — текст теперь на суб-табе «Содержание»
- **Island остаётся с 3 панелями:** Стиль, Позиция, Анимация
- **Dot navigation:** 3 точки вместо 4
- **Иконки collapsed:** Palette, LayoutTemplate, Sparkles (без Type)
- Всё остальное остаётся как есть

### Синхронизация между суб-табами
- **State поднят** в общий родитель Step 4 (BannerCustomization)
- При переключении между табами — state сохраняется
- Изменения на «Содержание» мгновенно видны на «Оформление» и наоборот
- Текст редактируется ТОЛЬКО на «Содержание»
- Стиль/позиция/анимация — ТОЛЬКО на «Оформление»

---

## Архитектура подсказок

### Подсказка вверху шага
При первом входе на Step 4 — показать информативную подсказку:
```
┌─────────────────────────────────────────────┐
│ ℹ️  Настройте содержание вашего баннера,     │
│    затем оформите его в визуальном           │
│    редакторе                                 │
└─────────────────────────────────────────────┘
```
- Можно скрыть (кнопка ×)
- Стиль: мягкий `bg-muted` блок с иконкой, не alert

### Подсказки внутри секций
- У toggle «Слово в тексте»: tooltip «Выбранное слово станет кликабельной ссылкой на документ cookie»
- У «Редактировать вручную»: tooltip «Можно доработать текст шаблона»
- У переключателя «Попап / Страница»: inline текст под каждым вариантом

---

## Технический план

### Новые файлы
```
components/
├── step4-editor.tsx              # Контейнер Step 4 с суб-табами
├── step4-content-tab.tsx         # Суб-таб «Содержание»
├── step4-content-preview.tsx     # Превью баннера для «Содержание»
```

### Модифицируемые файлы
```
├── cookie-generator-client.tsx   # Заменить <BannerPreview/> на <Step4Editor/>
├── banner-preview.tsx            # Убрать внутренний state, принимать props
├── liquid-glass-island.tsx       # Убрать text panel, 3 панели вместо 4
├── island-panels/index.ts        # Убрать экспорт TextPanel (или оставить для переиспользования)
├── banner-styles/types.ts        # Добавить showDecline, showSettings, linkWord, linkLine
├── banner-styles/classic.tsx     # Поддержка ссылки в тексте / строки-ссылки
├── banner-styles/glass.tsx       # То же самое
```

### Изменения в типах (types.ts)

```typescript
// Добавить в TextState:
interface TextState {
  tone: ToneId
  title: string
  desc: string
  accept: string
  decline: string
  settings: string              // НОВОЕ: текст кнопки «Настроить»
  showDecline: boolean          // НОВОЕ: показывать кнопку «Отклонить»
  showSettings: boolean         // НОВОЕ: показывать кнопку «Настроить»
  linkWordEnabled: boolean      // НОВОЕ: ссылка-слово включена
  linkWord: string              // НОВОЕ: какое слово = ссылка (default: 'cookie')
  linkLineEnabled: boolean      // НОВОЕ: строка-ссылка включена
  linkLineText: string          // НОВОЕ: текст строки (default: 'Подробнее о cookie')
  linkTarget: 'popup' | 'page'  // НОВОЕ: куда ведёт ссылка
  linkUrl: string               // НОВОЕ: URL страницы (если linkTarget === 'page')
}
```

### Порядок реализации

1. **Обновить типы** — TextState, BannerStyleProps
2. **Создать step4-editor.tsx** — контейнер с суб-табами, поднятый state
3. **Создать step4-content-tab.tsx** — левая колонка (тон, кнопки, ссылка, ручное редактирование)
4. **Создать step4-content-preview.tsx** — правая колонка (баннер на нейтральном фоне)
5. **Обновить banner-preview.tsx** — принимать customization как props (не внутренний state)
6. **Обновить liquid-glass-island.tsx** — убрать text panel, 3 панели
7. **Обновить banner styles** (classic.tsx, glass.tsx) — поддержка ссылки + toggle кнопок
8. **Подключить в cookie-generator-client.tsx** — заменить BannerPreview на Step4Editor
9. **Стили** — CSS для суб-табов, подсказок, layout «Содержание»

---

## Дизайн-решения

### Стиль суб-табов
- **Segmented control** (как в iOS) — два сегмента с иконками
- Не underline tabs (слишком похоже на основной wizard)
- Не кнопки (слишком агрессивно)
- Высота: ~40px, скруглённые, мягкий фон
- Активный таб: `bg-background` с тенью, неактивный: прозрачный
- Иконки: 📝 (Pencil) для Содержания, 🎨 (Palette) для Оформления

### Стиль секций «Содержание»
- Precision Minimalism (как весь dashboard)
- Чёткие labels, компактные поля
- Toggle switches для вкл/выкл кнопок и ссылок
- Свёрнутая секция «Редактировать вручную» — border-dashed или ghost button
- Нет backdrop-blur, нет gradients (это tools, не landing)

### Адаптив (мобильный)
- На мобильном: одна колонка, превью над настройками или под ними
- Суб-табы остаются вверху
- На «Оформление»: island может быть внизу экрана (не draggable на мобильном)

---

## Что НЕ меняется
- Шаги wizard (5 шагов, порядок тот же)
- Background Switcher Island (остаётся на «Оформление»)
- Все стили баннера (classic, glass + будущие)
- Liquid Glass Island визуальный стиль (glass effect, drag)
- Панели Design, Position, Animation (содержимое не меняется)
- Данные шагов 1-3 и шага 5

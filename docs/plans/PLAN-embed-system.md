# –ü–ª–∞–Ω: Embed-—Å–∏—Å—Ç–µ–º–∞ Floqly ‚Äî –æ—Ç –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –∫ —Ä–∞–±–æ—á–µ–º—É –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

Embed-–∫–æ–¥ (`<script src="https://cdn.floqly.ru/cookie.js" data-id="...">`) —Å–µ–π—á–∞—Å ‚Äî –∑–∞–≥–ª—É—à–∫–∞. –ù–∏ —Å–∫—Ä–∏–ø—Ç, –Ω–∏ API, –Ω–∏ CDN –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç. –ù—É–∂–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª–Ω—É—é —Ü–µ–ø–æ—á–∫—É: **build ‚Üí serve ‚Üí config API ‚Üí event tracking ‚Üí dashboard stats** ‚Äî —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç –º–æ–≥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –∫–æ–¥–∞ –∏ –≤–∏–¥–∂–µ—Ç —Ä–∞–±–æ—Ç–∞–ª –Ω–∞ –µ–≥–æ —Å–∞–π—Ç–µ.

### –ö–ª—é—á–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
- **–û—Ç–¥–µ–ª—å–Ω—ã–π embed-–∫–æ–¥ –Ω–∞ –∫–∞–∂–¥—ã–π –≤–∏–¥–∂–µ—Ç** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ–¥—Ö–æ–¥, —Å–º. –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –Ω–∏–∂–µ)
- **–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–∏–¥–∂–µ—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**: cookie + simple/smart + –±—É–¥—É—â–∏–µ (–æ–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫ –∏ –¥—Ä.) ‚Äî –≤—Å–µ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- **Upgrade-path**: –¢–û–õ–¨–ö–û Simple ‚Üí Smart –≤–∏–¥–∂–µ—Ç (–∑–∞–º–µ–Ω–∞, –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ `data-widget-id`). Cookie, –æ–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫ –∏ –¥—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã ‚Äî –æ—Å—Ç–∞—é—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- **–î–∏–∑–∞–π–Ω –∏–∑ –õ–ö** –æ—Ç—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (–ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** (–ø—Ä–æ—Å–º–æ—Ç—Ä—ã, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è) –≤–∏–¥–Ω–∞ –≤ –¥–∞—à–±–æ—Ä–¥–µ
- **–ò–ª—å—è** (–ø–∞—Ä—Ç–Ω—ë—Ä) –∑–∞–ø—É—Å–∫–∞–µ—Ç AI backend –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º Python-—Å–µ—Ä–≤–∏—Å–µ ‚Äî –Ω—É–∂–Ω–∞ —Ç–æ—á–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: per-widget embed vs project-wide loader

**–í—ã–±—Ä–∞–Ω: per-widget embed** (–∫–∞–∂–¥—ã–π –≤–∏–¥–∂–µ—Ç ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π `<script data-widget-id="...">`)

| –ö—Ä–∏—Ç–µ—Ä–∏–π | Per-widget (‚úÖ –≤—ã–±—Ä–∞–Ω–æ) | Project-wide loader |
|----------|------------------------|---------------------|
| Bundle size | Cookie ~5KB, Smart ~50-100KB ‚Äî –≥—Ä—É–∑–∏–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ–µ | –û–¥–∏–Ω bundle —Å–æ –≤—Å–µ–º = —Ç—è–∂–µ–ª–µ–µ |
| –ò–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫ | –ü–æ–ª–æ–º–∫–∞ Smart –Ω–µ –ª–æ–º–∞–µ—Ç Cookie | –û–¥–Ω–∞ –æ—à–∏–±–∫–∞ ‚Üí –≤—Å—ë –ø–∞–¥–∞–µ—Ç |
| –°–∫–æ—Ä–æ—Å—Ç—å cookie | –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è (–º–∞–ª–µ–Ω—å–∫–∏–π —Å–∫—Ä–∏–ø—Ç) | –ñ–¥—ë—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—â–µ–≥–æ bundle |
| –ü—Ä–æ–¥–∞–∂–∞ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ | –õ–µ–≥–∫–æ ‚Äî –∫–∞–∂–¥—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º | –°–ª–æ–∂–Ω–µ–µ —Ä–∞–∑–¥–µ–ª–∏—Ç—å |
| Simple ‚Üí Smart | `data-widget-id` —Ç–æ—Ç –∂–µ, —Ç–∏–ø –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ | –¢–∞–∫ –∂–µ |
| UX –∫–ª–∏–µ–Ω—Ç–∞ | 2-3 script —Ç–µ–≥–∞ | 1 script —Ç–µ–≥ |
| –ü–µ—Ä–µ—Ö–æ–¥ –∫ project-wide | –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å loader –ø–æ–∑–∂–µ | ‚Äî |

**Embed-—Ñ–æ—Ä–º–∞—Ç:**
```html
<!-- Cookie –±–∞–Ω–Ω–µ—Ä -->
<script src="https://floqly.ru/embed/fl-helper.iife.js" data-widget-id="abc123"></script>

<!-- –í–∏–¥–∂–µ—Ç (simple ‚Üí smart upgrade –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) -->
<script src="https://floqly.ru/embed/fl-helper.iife.js" data-widget-id="xyz789"></script>
```

**–û–¥–∏–Ω —Å–∫—Ä–∏–ø—Ç** (`fl-helper.iife.js`) –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ ‚Äî –Ω–æ `data-widget-id` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–∏–¥–∂–µ—Ç. –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥ –æ–¥–Ω–æ–≥–æ –≤–∏–¥–∂–µ—Ç–∞ –∏ —Å–æ–∑–¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ –µ–≥–æ.

**–ï—Å–ª–∏ –ò–ª—å—è —Å–∫–∞–∂–µ—Ç –ø–æ-–¥—Ä—É–≥–æ–º—É:** –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å `main.ts` (–æ–¥–∏–Ω —Ñ–∞–π–ª) ‚Äî –≤–º–µ—Å—Ç–æ fetch –æ–¥–Ω–æ–≥–æ –≤–∏–¥–∂–µ—Ç–∞ ‚Üí fetch –ø–æ project_id. –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π –ø–æ–¥–¥–µ—Ä–∂–∏—Ç –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞. –°–º. —Å–µ–∫—Ü–∏—é "–û–±—Ä–∞—Ç–∏–º–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è" –≤ –∫–æ–Ω—Ü–µ.

### –ß—Ç–æ —É–∂–µ –µ—Å—Ç—å (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å):
- `apps/widget/` ‚Äî Vite + TypeScript, Shadow DOM, IIFE build ‚Üí `fl-helper.iife.js`
- `apps/widget/src/main.ts` ‚Äî auto-init –ø–æ `data-widget-id`, fetch –∫–æ–Ω—Ñ–∏–≥–∞
- `apps/widget/src/core/widget.ts` ‚Äî –ø–æ–ª–Ω—ã–π Widget class (mount/destroy/open/close/events)
- `apps/widget/src/core/types.ts` ‚Äî WidgetConfig, WidgetType, WidgetState
- DB: `widgets` (—Å `embed_key`, `config` JSONB, `views_count`, `interactions_count`)
- DB: `analytics_events` (event_type, event_data, visitor_id, page_url...)
- DB: SQL —Ñ—É–Ω–∫—Ü–∏–∏ `increment_widget_views()`, `increment_widget_interactions()`
- DB: RLS ‚Äî public SELECT active widgets, public INSERT analytics_events
- `createAdminClient()` –≤ `apps/web/src/lib/supabase/server.ts` ‚Äî service role
- Middleware –∏—Å–∫–ª—é—á–∞–µ—Ç `/api/widgets/public` –∏–∑ auth

---

## –§–∞–∑–∞ 1: Widget Build Pipeline + Static Serving (~8 —Ñ–∞–π–ª–æ–≤)

### 1.1 MODIFY: `apps/widget/vite.config.ts`
- –î–æ–±–∞–≤–∏—Ç—å `define: { 'import.meta.env.VITE_API_URL': JSON.stringify(process.env.VITE_API_URL || 'https://floqly.ru') }`
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ env –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ build (–Ω–µ runtime)

### 1.2 MODIFY: `apps/widget/src/main.ts`
- –û—Å—Ç–∞–≤–∏—Ç—å `data-widget-id` (per-widget –ø–æ–¥—Ö–æ–¥)
- Fetch: `${API_URL}/api/v1/embed/${widgetId}` ‚Üí –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥ **–æ–¥–Ω–æ–≥–æ** –≤–∏–¥–∂–µ—Ç–∞
- –ü–æ `type` –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ ‚Üí —Å–æ–∑–¥–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –≤–∏–¥–∂–µ—Ç (cookie/simple/smart)
- `window.Floqly._instances = new Map<string, BaseWidget>()` ‚Äî –º–Ω–æ–∂–µ—Å—Ç–≤–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ (–Ω–µ—Å–∫–æ–ª—å–∫–æ script —Ç–µ–≥–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
- –ö–∞–∂–¥—ã–π `<script>` —Ç–µ–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–≤–æ–π –≤–∏–¥–∂–µ—Ç, –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å –¥—Ä—É–≥–∏–º–∏
- –î–æ–±–∞–≤–∏—Ç—å shared `reportEvent(widgetId, eventType, eventData)` ‚Üí POST –≤ API
- –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ–º–µ–Ω–∞: `window.location.hostname` vs `allowedDomains` –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞

### 1.3 MODIFY: `apps/widget/src/core/widget.ts`
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `reportEvent(type, data)` ‚Äî POST –≤ `/api/v1/embed/events`
- –ü—Ä–∏ mount ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ `reportEvent('view', { page_url, referrer })`
- –ü—Ä–∏ interaction (–∫–ª–∏–∫ –ø–æ –±–∞–Ω–Ω–µ—Ä—É, accept/decline) ‚Üí `reportEvent('interaction', { action })`
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å cookie-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –ª–æ–≥–∏–∫—É:
  - –ü–æ–∫–∞–∑ –±–∞–Ω–Ω–µ—Ä–∞ (–∏–∑ config.bannerCustomization)
  - –ö–Ω–æ–ø–∫–∏ accept/decline
  - –ó–∞–ø–∏—Å—å —Å–æ–≥–ª–∞—Å–∏—è –≤ localStorage + cookie

### 1.4 CREATE: `apps/widget/src/widgets/cookie-widget.ts`
- –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç –¥–ª—è cookie consent
- –†–µ–Ω–¥–µ—Ä–∏—Ç –±–∞–Ω–Ω–µ—Ä —Å –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–µ–π –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ (position, colors, text, backdrop)
- –õ–æ–≥–∏–∫–∞: –ø–æ–∫–∞–∑–∞—Ç—å ‚Üí accept/decline ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Üí —Å–∫—Ä—ã—Ç—å –Ω–∞ N –¥–Ω–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç styles –∏–∑ `config.bannerCustomization` (LiquidGlassIsland —Å—Ç–∏–ª–∏ –∏–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ)

### 1.5 MODIFY: `apps/widget/src/core/types.ts`
- –î–æ–±–∞–≤–∏—Ç—å `CookieWidgetConfig` ‚Äî extends WidgetConfig —Å cookie-specific –ø–æ–ª—è–º–∏
- –î–æ–±–∞–≤–∏—Ç—å `EmbedResponse` ‚Äî `{ projectId, widgets: WidgetConfig[] }`
- –î–æ–±–∞–≤–∏—Ç—å `EventPayload` ‚Äî `{ widget_id, event_type, event_data, visitor_id, page_url, referrer }`

### 1.6 MODIFY: `Dockerfile`
- –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞–¥–∏—é build widget: `RUN pnpm --filter @floqly/widget build`
- –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å `apps/widget/dist/` –≤ `apps/web/public/embed/` –ø–µ—Ä–µ–¥ Next.js build
- –î–æ–±–∞–≤–∏—Ç—å `ARG VITE_API_URL` –¥–ª—è build-time

### 1.7 MODIFY: `package.json` (root)
- –î–æ–±–∞–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç: `"widget:build": "pnpm --filter @floqly/widget build"`
- –û–±–Ω–æ–≤–∏—Ç—å `"build"`: —Å–Ω–∞—á–∞–ª–∞ widget build, –ø–æ—Ç–æ–º web build

### 1.8 MODIFY: `apps/web/next.config.ts`
- –î–æ–±–∞–≤–∏—Ç—å CORS headers –¥–ª—è `/embed/*` –∏ `/api/v1/embed/*`:
```ts
headers: async () => [{
  source: '/embed/:path*',
  headers: [
    { key: 'Access-Control-Allow-Origin', value: '*' },
    { key: 'Cache-Control', value: 'public, max-age=3600' },
  ]
}, {
  source: '/api/v1/embed/:path*',
  headers: [
    { key: 'Access-Control-Allow-Origin', value: '*' },
    { key: 'Access-Control-Allow-Methods', value: 'GET, POST, OPTIONS' },
    { key: 'Access-Control-Allow-Headers', value: 'Content-Type' },
  ]
}]
```

---

## –§–∞–∑–∞ 2: Public API Endpoints + Service Layer (~7 —Ñ–∞–π–ª–æ–≤)

### 2.0 CREATE: `apps/web/src/lib/services/embed-service.ts` ‚≠ê DB Abstraction
**–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π** ‚Äî –∏–∑–æ–ª–∏—Ä—É–µ—Ç Supabase –æ—Ç route handlers (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î):
- `getWidgetConfig(widgetId: string): Promise<EmbedWidgetConfig | null>` ‚Äî select widget by embed_key where status=active
- `getWidgetsByProject(projectId: string): Promise<EmbedWidgetConfig[]>` ‚Äî –¥–ª—è –±—É–¥—É—â–µ–≥–æ project-wide loader
- `getProjectDomains(projectId: string): Promise<string[]>` ‚Äî select project domains for Origin check
- `recordAnalyticsEvent(event: AnalyticsEventInput): Promise<void>` ‚Äî insert + increment counters
- –í–Ω—É—Ç—Ä–∏: `createAdminClient()` –∏–∑ `apps/web/src/lib/supabase/server.ts`
- **–ü—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å Supabase:** –º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Ñ–∞–π–ª

### 2.1 CREATE: `apps/web/src/app/api/v1/embed/[widgetId]/route.ts`
**GET** `/api/v1/embed/{widgetId}` ‚Äî **PUBLIC**, no auth
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `widgetId` ‚Äî —ç—Ç–æ `embed_key` –∏–∑ widgets table (8-byte hex)
- –í—ã–∑—ã–≤–∞–µ—Ç `EmbedService.getWidgetConfig(widgetId)` ‚Üê **—á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π**
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–µ–Ω–∞: `Origin` header vs project.domains
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `{ widget: { id, type, config } }` ‚Äî –æ–¥–∏–Ω –≤–∏–¥–∂–µ—Ç
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ: `Cache-Control: public, s-maxage=60, stale-while-revalidate=300`
- Zod-–≤–∞–ª–∏–¥–∞—Ü–∏—è widgetId format
- 404 –µ—Å–ª–∏ –≤–∏–¥–∂–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ status ‚â† active

### 2.2 CREATE: `apps/web/src/app/api/v1/embed/events/route.ts`
**POST** `/api/v1/embed/events` ‚Äî **PUBLIC**, no auth
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: `{ widget_id, event_type, event_data, visitor_id, session_id, page_url, referrer, user_agent }`
- Zod-–≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞: –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞ event_data)
- –í—ã–∑—ã–≤–∞–µ—Ç `EmbedService.recordAnalyticsEvent(...)` ‚Üê **—á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π**
- IP-–∞–¥—Ä–µ—Å –∏–∑ `request.headers.get('x-forwarded-for')`
- –û—Ç–≤–µ—Ç: `{ ok: true }` (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
- Rate limiting: TODO ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –¥–ª—è –±—É–¥—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (Upstash Redis)

### 2.3 CREATE: `apps/web/src/app/api/v1/embed/events/route.ts` OPTIONS handler
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç CORS preflight –æ—Ç–≤–µ—Ç

### 2.4 MODIFY: `apps/web/src/middleware.ts`
- –î–æ–±–∞–≤–∏—Ç—å –≤ matcher –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: `api/v1/embed` ‚Äî —á—Ç–æ–±—ã public endpoints –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —á–µ—Ä–µ–∑ auth middleware
- –û–±–Ω–æ–≤–∏—Ç—å regexp: `'/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$|api/health|api/widgets/public|api/v1/embed|embed).*)'`

### 2.5 MODIFY: `apps/web/src/lib/supabase/middleware.ts`
- –ù–ï –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å ‚Äî middleware matcher —É–∂–µ –∏—Å–∫–ª—é—á–∏—Ç `/api/v1/embed`

---

## –§–∞–∑–∞ 3: Dashboard Integration ‚Äî Stats & Embed Code (~4 —Ñ–∞–π–ª–∞)

### 3.1 MODIFY: `apps/web/src/components/dashboard/project-card.tsx`
- –ó–∞–º–µ–Ω–∏—Ç—å –∑–∞–≥–ª—É—à–∫—É embed-–∫–æ–¥–∞:
  ```ts
  // –ë—ã–ª–æ:
  const code = `<script src="https://cdn.floqly.ru/cookie.js" data-id="${id}"></script>`
  // –°—Ç–∞–ª–æ (per-widget ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º embed_key –≤–∏–¥–∂–µ—Ç–∞):
  const code = `<script src="https://floqly.ru/embed/fl-helper.iife.js" data-widget-id="${widget.embed_key}"></script>`
  ```
- –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ `views_count` / `interactions_count` –∏–∑ widget –¥–∞–Ω–Ω—ã—Ö (—É–∂–µ –µ—Å—Ç—å –≤ Widget type)

### 3.2 MODIFY: `apps/web/src/app/(tools)/tools/cookie-generator/components/result-step.tsx`
- –û–±–Ω–æ–≤–∏—Ç—å preview embed-–∫–æ–¥–∞ (—Å—Ç—Ä–æ–∫–∞ ~189) –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å `embed_key` –∏–ª–∏ `project_id` –∫–∞–∫ data-attribute

### 3.3 CREATE: `apps/web/src/lib/hooks/use-widget-stats.ts`
- –•—É–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–∏–¥–∂–µ—Ç–∞ –∏–∑ `analytics_events`
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ event_type, –ø–æ –¥–Ω—è–º (–¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –≤ –±—É–¥—É—â–µ–º)
- `useQuery(['widget-stats', widgetId], ...)`

### 3.4 MODIFY: `apps/web/src/components/dashboard/project-card.tsx`
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ stats: –ø—Ä–æ—Å–º–æ—Ç—Ä—ã, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è, –∫–æ–Ω–≤–µ—Ä—Å–∏—é (accepts/declines)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `useWidgetStats()` –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ `widget.views_count` / `widget.interactions_count`

---

## –§–∞–∑–∞ 4: Cookie Widget Implementation (~3 —Ñ–∞–π–ª–∞)

### 4.1 CREATE: `apps/widget/src/widgets/cookie-banner.ts`
- –†–µ–Ω–¥–µ—Ä cookie –±–∞–Ω–Ω–µ—Ä–∞ –≤ Shadow DOM
- –ü–∞—Ä—Å–∏—Ç `bannerCustomization` –∏–∑ config: position, theme, colors, text, backdrop
- –ö–Ω–æ–ø–∫–∏: ¬´–ü—Ä–∏–Ω—è—Ç—å –≤—Å–µ¬ª / ¬´–û—Ç–∫–ª–æ–Ω–∏—Ç—å¬ª / ¬´–ù–∞—Å—Ç—Ä–æ–∏—Ç—å¬ª
- –ü—Ä–∏ accept ‚Üí `localStorage.setItem('floqly_cookie_consent', JSON.stringify({...}))`
- –ü—Ä–∏ accept ‚Üí `document.cookie = 'floqly_consent=accepted; max-age=...; path=/; SameSite=Lax'`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: –µ—Å–ª–∏ consent —É–∂–µ –¥–∞–Ω ‚Üí –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–∞–Ω–Ω–µ—Ä
- `reportEvent('cookie_accept')` / `reportEvent('cookie_decline')`

### 4.2 CREATE: `apps/widget/src/widgets/cookie-styles.ts`
- CSS-—à–∞–±–ª–æ–Ω –¥–ª—è cookie –±–∞–Ω–Ω–µ—Ä–∞
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ LiquidGlassIsland —Å—Ç–∏–ª–∏ –∏–∑ –¥–∞—à–±–æ—Ä–¥–∞
- Responsive: mobile/desktop
- Dark/light theme support

### 4.3 MODIFY: `apps/widget/src/main.ts`
- Router: –ø–æ `widget.type` —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –≤–∏–¥–∂–µ—Ç:
  - `'cookie'` ‚Üí CookieBanner
  - `'simple'` ‚Üí Widget (—Ç–µ–∫—É—â–∏–π –∫–ª–∞—Å—Å) ‚Äî –±—É–¥—É—â–µ–µ
  - `'ai_chat'` ‚Üí SmartWidget ‚Äî –±—É–¥—É—â–µ–µ (–∑–∞–≥–ª—É—à–∫–∞)

---

## –§–∞–∑–∞ 5: Publish Flow –≤ Dashboard (~2 —Ñ–∞–π–ª–∞)

### 5.1 MODIFY: `apps/web/src/components/dashboard/project-card.tsx`
- –ö–Ω–æ–ø–∫–∞ ¬´–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å¬ª ‚Üí –º–µ–Ω—è–µ—Ç `widgets.status` –Ω–∞ `'active'` + `published_at = now()`
- –ö–Ω–æ–ø–∫–∞ ¬´–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å¬ª ‚Üí `status = 'paused'`
- Embed-–∫–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ `status = 'active'`

### 5.2 CREATE: `apps/web/src/app/(dashboard)/dashboard/tools/cookie-generator/publish/page.tsx` (OPTIONAL)
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç embed-–∫–æ–¥ —Å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –ü—Ä–µ–≤—å—é –∫–∞–∫ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –±–∞–Ω–Ω–µ—Ä
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: ¬´–í–∏–¥–∂–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω / –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω¬ª

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

**–≠—Ç–∞–ø A (MVP ‚Äî –¥–µ–ª–∞–µ–º –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å):**
1. Widget build pipeline (1.1, 1.6, 1.7) ‚Äî —á—Ç–æ–±—ã `fl-helper.iife.js` –ø–æ–ø–∞–¥–∞–ª –≤ `public/embed/`
2. CORS + Next.js config (1.8)
3. Middleware (2.4)
4. **–°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π** (2.0) ‚Äî `embed-service.ts` (–∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –æ—Ç Supabase)
5. Public config API (2.1) ‚Äî `/api/v1/embed/[widgetId]` ‚Üí —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å (per-widget)
6. Public events API (2.2) ‚Äî `/api/v1/embed/events` ‚Üí —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
7. –û–±–Ω–æ–≤–∏—Ç—å main.ts (1.2) ‚Äî `data-widget-id` + fetch config + multi-instance support
8. –û–±–Ω–æ–≤–∏—Ç—å embed-–∫–æ–¥ –≤ UI (3.1, 3.2) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å `embed_key` –≤–∏–¥–∂–µ—Ç–∞

**–≠—Ç–∞–ø B (Cookie Widget):**
8. Cookie banner widget (4.1, 4.2)
9. Router –≤ main.ts (4.3)
10. Event tracking –≤ widget (1.3)

**–≠—Ç–∞–ø C (Dashboard Stats):**
11. Publish flow (5.1)
12. Widget stats hook (3.3)
13. Stats display (3.4)

---

## –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å (–ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫)

| # | –î–µ–π—Å—Ç–≤–∏–µ | –§–∞–π–ª | –§–∞–∑–∞ |
|---|----------|------|------|
| 1 | MODIFY | `apps/widget/vite.config.ts` | 1 |
| 2 | MODIFY | `apps/widget/src/main.ts` | 1, 4 |
| 3 | MODIFY | `apps/widget/src/core/widget.ts` | 1 |
| 4 | MODIFY | `apps/widget/src/core/types.ts` | 1 |
| 5 | CREATE | `apps/widget/src/widgets/cookie-banner.ts` | 4 |
| 6 | CREATE | `apps/widget/src/widgets/cookie-styles.ts` | 4 |
| 7 | MODIFY | `Dockerfile` | 1 |
| 8 | MODIFY | `package.json` (root) | 1 |
| 9 | MODIFY | `apps/web/next.config.ts` | 1 |
| 10 | CREATE | `apps/web/src/lib/services/embed-service.ts` ‚≠ê | 2 |
| 11 | CREATE | `apps/web/src/app/api/v1/embed/[widgetId]/route.ts` | 2 |
| 12 | CREATE | `apps/web/src/app/api/v1/embed/events/route.ts` | 2 |
| 13 | MODIFY | `apps/web/src/middleware.ts` | 2 |
| 14 | MODIFY | `apps/web/src/components/dashboard/project-card.tsx` | 3, 5 |
| 15 | MODIFY | `apps/web/src/app/(tools)/tools/cookie-generator/components/result-step.tsx` | 3 |
| 16 | CREATE | `apps/web/src/lib/hooks/use-widget-stats.ts` | 3 |
| 17 | CREATE | `apps/web/src/app/(dashboard)/dashboard/tools/cookie-generator/publish/page.tsx` | 5 (opt) |

‚≠ê = –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –±—É–¥—É—â–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏ —Å Supabase

---

## –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

| –ß—Ç–æ | –§–∞–π–ª | –ó–∞—á–µ–º |
|-----|------|-------|
| `createAdminClient()` | `apps/web/src/lib/supabase/server.ts` | Service role –¥–ª—è public API (bypass RLS) |
| `createClient()` (server) | `apps/web/src/lib/supabase/server.ts` | Auth-protected API |
| `increment_widget_views()` | SQL function –≤ Supabase | –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ |
| `increment_widget_interactions()` | SQL function –≤ Supabase | –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π |
| `Widget` class | `apps/widget/src/core/widget.ts` | –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ |
| `useWidget()` | `apps/web/src/lib/hooks/use-widget.ts` | –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ –≤ –¥–∞—à–±–æ—Ä–¥–µ |
| `useCurrentProject()` | `apps/web/src/lib/hooks/use-current-project.ts` | –¢–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç |
| `StoredWidgetConfig` | `apps/web/src/lib/hooks/use-widget.ts` | –¢–∏–ø—ã –∫–æ–Ω—Ñ–∏–≥–∞ |
| `Project.domains[]` | `apps/web/src/lib/stores/project-store.ts` | –°–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Origin |

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—Å—Ö–µ–º–∞ –ø–æ—Ç–æ–∫–∞)

```
–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Å–∞–π—Ç                          floqly.ru (Next.js)                    Supabase
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                         ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

<!-- Cookie –±–∞–Ω–Ω–µ—Ä -->
<script src="floqly.ru/embed/fl-helper.iife.js" data-widget-id="a1b2c3"></script>
<!-- –í–∏–¥–∂–µ—Ç —á–∞—Ç–∞ (simple ‚Üí smart –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏) -->
<script src="floqly.ru/embed/fl-helper.iife.js" data-widget-id="x7y8z9"></script>

  1. –ö–∞–∂–¥—ã–π —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è (–æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ static file –∏–∑ /public/embed/)
  2. –ß–∏—Ç–∞–µ—Ç —Å–≤–æ–π data-widget-id (embed_key)
  3. GET /api/v1/embed/{embed_key}  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫  EmbedService    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫  widgets table
                                              (service role)         (by embed_key, status=active)
  4. –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥ –≤–∏–¥–∂–µ—Ç–∞        ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   JSON response   ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ   config JSONB

  5. –ü–æ type —Å–æ–∑–¥–∞—ë—Ç –Ω—É–∂–Ω—ã–π –≤–∏–¥–∂–µ—Ç:
     type='cookie'  ‚Üí CookieBanner (Shadow DOM –±–∞–Ω–Ω–µ—Ä)
     type='simple'  ‚Üí SimpleWidget (–∫–Ω–æ–ø–∫–∞ + –∫–∞–Ω–∞–ª—ã —Å–≤—è–∑–∏)
     type='ai_chat' ‚Üí SmartWidget (AI —á–∞—Ç, –ò–ª—å—è backend)

  6. POST /api/v1/embed/events     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫  EmbedService    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫  analytics_events
     { widget_id, event_type,                                       + increment_widget_views()
       visitor_id, page_url }                                       + increment_widget_interactions()

  7. Dashboard –≤–∏–¥–∏—Ç stats          ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  useWidget()     ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ   views_count, interactions_count
```

---

## –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

### –ü–æ—Å–ª–µ –≠—Ç–∞–ø–∞ A:
1. `pnpm widget:build` ‚Äî —Ñ–∞–π–ª `apps/widget/dist/fl-helper.iife.js` —Å–æ–∑–¥–∞—ë—Ç—Å—è
2. `pnpm build` ‚Äî Next.js build –±–µ–∑ –æ—à–∏–±–æ–∫, `fl-helper.iife.js` –≤ `/public/embed/`
3. `curl http://localhost:3000/embed/fl-helper.iife.js` ‚Äî 200, JS-—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
4. `curl http://localhost:3000/api/v1/embed/{embed_key}` ‚Äî 200, JSON —Å –∫–æ–Ω—Ñ–∏–≥–æ–º –≤–∏–¥–∂–µ—Ç–∞
5. `curl -X POST http://localhost:3000/api/v1/embed/events -d '...'` ‚Äî 200
6. Middleware: protected routes –≤—Å—ë –µ—â—ë —Ç—Ä–µ–±—É—é—Ç auth, embed endpoints ‚Äî –Ω–µ—Ç

### –ü–æ—Å–ª–µ –≠—Ç–∞–ø–∞ B:
7. –°–æ–∑–¥–∞—Ç—å HTML-—Ñ–∞–π–ª —Å embed-–∫–æ–¥–æ–º, –æ—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Üí cookie –±–∞–Ω–Ω–µ—Ä –ø–æ—è–≤–ª—è–µ—Ç—Å—è
8. –ù–∞–∂–∞—Ç—å ¬´–ü—Ä–∏–Ω—è—Ç—å¬ª ‚Üí –±–∞–Ω–Ω–µ—Ä —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è, localStorage –∑–∞–ø–∏—Å–∞–Ω
9. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É ‚Üí –±–∞–Ω–Ω–µ—Ä –ù–ï –ø–æ—è–≤–ª—è–µ—Ç—Å—è (consent —É–∂–µ –¥–∞–Ω)
10. –í Supabase analytics_events ‚Üí –∑–∞–ø–∏—Å–∏ view –∏ cookie_accept

### –ü–æ—Å–ª–µ –≠—Ç–∞–ø–∞ C:
11. –í –¥–∞—à–±–æ—Ä–¥–µ ProjectCard ‚Üí —Ä–µ–∞–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã views/interactions
12. ¬´–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å¬ª ‚Üí `status = 'active'`, embed —Ä–∞–±–æ—Ç–∞–µ—Ç
13. ¬´–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å¬ª ‚Üí `status = 'paused'`, –≤–∏–¥–∂–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ

---

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ä—É—á–Ω—É—é (–æ—Ç–¥–µ–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç)

–û—Ç–¥–µ–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç `docs/plans/PLAN-embed-system-setup.md` —Å —à–∞–≥–∞–º–∏:
1. **TimeWeb**: –¥–æ–±–∞–≤–∏—Ç—å env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ Docker (VITE_API_URL)
2. **DNS**: (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Å–æ–∑–¥–∞—Ç—å `cdn.floqly.ru` –∫–∞–∫ CNAME –Ω–∞ floqly.ru ‚Äî –¥–ª—è –±—É–¥—É—â–µ–≥–æ CDN
3. **Supabase**: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å RLS policies, —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ SQL functions —Å—É—â–µ—Å—Ç–≤—É—é—Ç
4. **GitHub**: –ø—Ä–æ—Å—Ç–æ push –≤ main ‚Äî autodeploy —Å–¥–µ–ª–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–µ
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π HTML, –≤—Å—Ç–∞–≤–∏—Ç—å embed-–∫–æ–¥, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

---

## üîÆ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –Ω–∞ –±—É–¥—É—â–µ–µ (–ù–ï —Ä–µ–∞–ª–∏–∑—É–µ–º —Å–µ–π—á–∞—Å, –Ω–æ —É—á–∏—Ç—ã–≤–∞–µ–º –≤ –∫–æ–¥–µ)

### A. –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–∏–¥–∂–µ—Ç–æ–≤ –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚Äî –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

**–ü—Ä–∏–Ω—Ü–∏–ø:** API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–º–∞—Å—Å–∏–≤** –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞. –ó–∞–≥—Ä—É–∑—á–∏–∫ —Å–æ–∑–¥–∞—ë—Ç **–æ—Ç–¥–µ–ª—å–Ω—ã–π Shadow DOM –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ. –ö–∞–∂–¥—ã–π –≤–∏–¥–∂–µ—Ç:
- –ò–º–µ–µ—Ç —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `widget_id` –∏ `type`
- –†–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º Shadow DOM (CSS –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç)
- –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–µ–π –ø–æ–∑–∏—Ü–∏–µ–π (position –∏–∑ config)
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–∏ —Å–æ–±—ã—Ç–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ

**Upgrade-path Simple ‚Üí Smart:**
- –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç Smart Widget, –µ–≥–æ `type` –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `ai_chat`
- –ó–∞–≥—Ä—É–∑—á–∏–∫ –≤–∏–¥–∏—Ç `type: 'ai_chat'` –≤–º–µ—Å—Ç–æ `type: 'simple'` ‚Üí —Å–æ–∑–¥–∞—ë—Ç SmartWidget –≤–º–µ—Å—Ç–æ SimpleWidget
- Cookie, –æ–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫, –∏ –¥—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã ‚Äî **–ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å** —Ä—è–¥–æ–º, —É –Ω–∏—Ö —Å–≤–æ–∏ type –∏ —Å–≤–æ–∏ Shadow DOM

**–í –∫–æ–¥–µ —É—á–∏—Ç—ã–≤–∞–µ–º:**
- `main.ts`: —Ü–∏–∫–ª –ø–æ `widgets[]`, –Ω–µ singleton
- `window.Floqly._instances: Map<string, BaseWidget>` –≤–º–µ—Å—Ç–æ `_instance`
- –ö–∞–∂–¥—ã–π –≤–∏–¥–∂–µ—Ç –∑–Ω–∞–µ—Ç —Å–≤–æ–π `position` ‚Üí –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞
- –î–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä —á–∏—Å—Ç–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

### B. –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (üí° –∏–¥–µ—è –ù–∏–∫–∏—Ç—ã)

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:** –ö–æ–≥–¥–∞ —É –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞—à–∏—Ö –≤–∏–¥–∂–µ—Ç–æ–≤ (cookie + smart + –æ–±—Ä–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫), –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –≤ –õ–ö:
- –ü—Ä–µ–≤—å—é —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–ª–∏–µ–Ω—Ç–∞ (—Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ—Ä–µ–∑ `useSiteScreenshot`)
- –ù–∞ –ø—Ä–µ–≤—å—é –≤–∏–¥–∂–µ—Ç—ã –ø–æ–∫–∞–∑–∞–Ω—ã –∫–∞–∫ draggable —ç–ª–µ–º–µ–Ω—Ç—ã
- –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å cookie –±–∞–Ω–Ω–µ—Ä –≤–ª–µ–≤–æ, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª Smart Widget —Å–ø—Ä–∞–≤–∞
- –ü–æ–∑–∏—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `config.position` –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–∂–µ—Ç–∞

**–í –∫–æ–¥–µ —É—á–∏—Ç—ã–≤–∞–µ–º:**
- `WidgetConfig.position` —É–∂–µ –µ—Å—Ç—å (bottom-right/bottom-left/top-right/top-left)
- –î–æ–±–∞–≤–∏—Ç—å `position.offsetX`, `position.offsetY` –¥–ª—è fine-tuning
- –ö–∞–∂–¥—ã–π –≤–∏–¥–∂–µ—Ç —É–≤–∞–∂–∞–µ—Ç —Å–≤–æ—é –ø–æ–∑–∏—Ü–∏—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –õ–ö –æ—Ç—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ
- **–ù–ï —Ä–µ–∞–ª–∏–∑—É–µ–º** drag-and-drop —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å–µ–π—á–∞—Å ‚Äî —Ç–æ–ª—å–∫–æ data model –≥–æ—Ç–æ–≤–∏–º

### C. –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –æ—Ç Supabase ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü–æ—Å–ª–µ MVP –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–µ—Ö–æ–¥ —Å Supabase –Ω–∞ –¥—Ä—É–≥—É—é –ë–î. –ß—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å –≤—Å—ë:

**–í –∫–æ–¥–µ —É—á–∏—Ç—ã–≤–∞–µ–º:**
- –í—Å–µ Supabase-–∑–∞–ø—Ä–æ—Å—ã –≤ API routes –¥–µ–ª–∞–µ–º —á–µ—Ä–µ–∑ **—Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π** (–Ω–µ –Ω–∞–ø—Ä—è–º—É—é –≤ route handler):
  ```
  apps/web/src/lib/services/widget-service.ts  ‚Äî getActiveWidgets(projectId), recordEvent(...)
  apps/web/src/lib/services/analytics-service.ts ‚Äî getStats(widgetId), recordEvent(...)
  ```
- Route handler –≤—ã–∑—ã–≤–∞–µ—Ç `WidgetService.getActiveWidgets(projectId)` ‚Äî –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ Supabase
- –°–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π –≤–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Supabase client ‚Äî –Ω–æ —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ, –≥–¥–µ –º–µ–Ω—è–µ–º –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
- **–ü–∞—Ç—Ç–µ—Ä–Ω:** Repository pattern light ‚Äî –Ω–µ over-engineer, –Ω–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å DB-—Å–ª–æ–π
- –¢–∏–ø—ã (`Widget`, `AnalyticsEvent`) ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç Supabase Database types
- RLS policies –∑–∞–º–µ–Ω—è—Ç—Å—è –Ω–∞ application-level checks –≤ —Å–µ—Ä–≤–∏—Å–Ω–æ–º —Å–ª–æ–µ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

**–ü—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å:**
1. `lib/services/*.ts` ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (SQL/ORM –≤–º–µ—Å—Ç–æ Supabase client)
2. `lib/supabase/` ‚Üí `lib/db/` ‚Äî –Ω–æ–≤—ã–π DB client
3. Auth ‚Äî —Å Supabase Auth –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É (NextAuth, custom JWT)
4. Realtime ‚Äî –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è Supabase Realtime

### D. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Floqly ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (üîú –±—É–¥—É—â–µ–µ)

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ù—É–∂–Ω–æ –≤–∏–¥–µ—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º ‚Äî —Ç–æ –∂–µ, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –≤–∏–¥–∏—Ç –≤ —Å–≤–æ—ë–º –¥–∞—à–±–æ—Ä–¥–µ, –Ω–æ aggregated + per-client.

**–í –∫–æ–¥–µ —É—á–∏—Ç—ã–≤–∞–µ–º:**
- `analytics_events` —Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `project_id` –∏ `widget_id` ‚Äî –º–æ–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –ª—é–±–æ–º—É –∫–ª–∏–µ–Ω—Ç—É
- SQL functions `increment_widget_views/interactions` —É–∂–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É—é—Ç ‚Äî –¥–∞–Ω–Ω—ã–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è
- API endpoint –¥–ª—è —Å–æ–±—ã—Ç–∏–π (`/api/v1/embed/events`) –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç **–≤—Å–µ** –¥–∞–Ω–Ω—ã–µ (visitor_id, page_url, referrer, user_agent, IP)
- –î–ª—è –∞–¥–º–∏–Ω–∫–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è:
  - –û—Ç–¥–µ–ª—å–Ω—ã–π middleware –¥–ª—è `/admin/*` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `role = 'admin'` –≤ profiles
  - –ò–ª–∏ Supabase Dashboard –Ω–∞–ø—Ä—è–º—É—é ‚Äî –¥–ª—è MVP –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
  - –ò–ª–∏ `apps/admin/` (—É–∂–µ –µ—Å—Ç—å –∑–∞–≥–ª—É—à–∫–∞ –≤ monorepo) —Å full read access –∫ analytics_events, widgets, projects
- **–°–µ–π—á–∞—Å:** –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ê–¥–º–∏–Ω–∫–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç embed-—Å–∏—Å—Ç–µ–º—É
- **–°–æ–≤–µ—Ç:** –Ω–∞ –ø–µ—Ä–≤–æ–µ –≤—Ä–µ–º—è –º–æ–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Supabase Table Editor (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

---

### E. –û–±—Ä–∞—Ç–∏–º–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è per-widget ‚Üí project-wide (–¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Å –ò–ª—å—ë–π)

**–¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:** –∫–∞–∂–¥—ã–π –≤–∏–¥–∂–µ—Ç ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π `<script data-widget-id="embed_key">`.

**–ï—Å–ª–∏ –ò–ª—å—è –ø–æ–ø—Ä–æ—Å–∏—Ç –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤ –æ–¥–∏–Ω –∫–æ–¥:**
–ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å **2 —Ñ–∞–π–ª–∞**:
1. `apps/widget/src/main.ts` ‚Äî —á–∏—Ç–∞—Ç—å `data-project-id` –≤–º–µ—Å—Ç–æ `data-widget-id`, fetch `/api/v1/embed/project/{projectId}` ‚Üí –ø–æ–ª—É—á–∞—Ç—å –º–∞—Å—Å–∏–≤ –≤–∏–¥–∂–µ—Ç–æ–≤, —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤—Å–µ
2. `apps/web/src/app/api/v1/embed/project/[projectId]/route.ts` ‚Äî –Ω–æ–≤—ã–π endpoint (—Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π —É–∂–µ –∏–º–µ–µ—Ç `getWidgetsByProject()`)

–û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ (—Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–ª–æ–π, Shadow DOM, event tracking, dashboard) ‚Äî **–Ω–µ –º–µ–Ω—è–µ—Ç—Å—è**.

**–ì–∏–±—Ä–∏–¥–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:** –º–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ–±–∞ –ø–æ–¥—Ö–æ–¥–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Äî `data-widget-id` –¥–ª—è per-widget, `data-project-id` –¥–ª—è project-wide. –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∫–æ–π –∞—Ç—Ä–∏–±—É—Ç –µ—Å—Ç—å.

---

## –î–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ü—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞—Ç—å `docs/plans/PLAN-embed-system-setup.md` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º:

### 1. TimeWeb ‚Äî –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
–î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Docker-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ TimeWeb:
- `VITE_API_URL=https://floqly.ru` ‚Äî URL –¥–ª—è –≤–∏–¥–∂–µ—Ç-—Å–∫—Ä–∏–ø—Ç–∞ (—É–∫–∞–∑—ã–≤–∞–µ—Ç –∫—É–¥–∞ —Å–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã)
- –û—Å—Ç–∞–ª—å–Ω—ã–µ env (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`) ‚Äî —É–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

### 2. DNS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –±—É–¥—É—â–µ–≥–æ CDN)
- –°–æ–∑–¥–∞—Ç—å CNAME –∑–∞–ø–∏—Å—å: `cdn.floqly.ru` ‚Üí `floqly.ru`
- –°–µ–π—á–∞—Å —Å–∫—Ä–∏–ø—Ç –æ—Ç–¥–∞—ë—Ç—Å—è —Å `floqly.ru/embed/fl-helper.iife.js`
- –ö–æ–≥–¥–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è CDN (Cloudflare, BunnyCDN) ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∏–º `cdn.floqly.ru` –Ω–∞ CDN

### 3. Supabase ‚Äî –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
- SQL —Ñ—É–Ω–∫—Ü–∏–∏ `increment_widget_views()` –∏ `increment_widget_interactions()` –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
- RLS policy "Anyone can view active widgets by embed_key" ‚Äî –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω–∞
- RLS policy "Anyone can create analytics events" ‚Äî –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω–∞
- –í—Å—ë —ç—Ç–æ —É–∂–µ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ `001_initial_schema.sql` ‚Äî –µ—Å–ª–∏ Supabase –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–æ –Ω–µ–π, —Ç–æ –û–ö

### 4. GitHub ‚Üí TimeWeb Autodeploy
- Push –≤ `main` ‚Üí TimeWeb –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç Docker image ‚Üí –¥–µ–ø–ª–æ–∏—Ç
- **–ù–∏—á–µ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ**

### 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `test.html` –Ω–∞ –ª—é–±–æ–º —Å–µ—Ä–≤–µ—Ä–µ –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ
- –í—Å—Ç–∞–≤–∏—Ç—å embed-–∫–æ–¥: `<script src="https://floqly.ru/embed/fl-helper.iife.js" data-widget-id="EMBED_KEY"></script>`
- –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Üí –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è cookie –±–∞–Ω–Ω–µ—Ä
- –ù–∞–∂–∞—Ç—å ¬´–ü—Ä–∏–Ω—è—Ç—å¬ª ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ Supabase Table Editor —á—Ç–æ –≤ `analytics_events` –ø–æ—è–≤–∏–ª–∞—Å—å –∑–∞–ø–∏—Å—å
- –í –¥–∞—à–±–æ—Ä–¥–µ Floqly ‚Üí ProjectCard ‚Üí —Å—á—ë—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ —É–≤–µ–ª–∏—á–∏–ª—Å—è

### 6. –î–ª—è –ò–ª—å–∏ ‚Äî —á—Ç–æ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ embed-—Å–∫—Ä–∏–ø—Ç–∞:**
- –ö–∞–∂–¥—ã–π –≤–∏–¥–∂–µ—Ç –∏–º–µ–µ—Ç —Å–≤–æ–π –æ—Ç–¥–µ–ª—å–Ω—ã–π `<script data-widget-id="...">` –Ω–∞ —Å–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞
- Cookie –±–∞–Ω–Ω–µ—Ä ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç, Simple/Smart –≤–∏–¥–∂–µ—Ç ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
- –§–∏–∑–∏—á–µ—Å–∫–∏ —ç—Ç–æ **–æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ JS-—Ñ–∞–π–ª** (`fl-helper.iife.js`), –Ω–æ `data-widget-id` –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–∞–∫–æ–π –≤–∏–¥–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å
- Simple ‚Üí Smart: —Ç–∏–ø –≤–∏–¥–∂–µ—Ç–∞ (`type`) –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Üí —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥ ‚Üí —Ä–µ–Ω–¥–µ—Ä–∏—Ç SmartWidget –≤–º–µ—Å—Ç–æ SimpleWidget. –ö–ª–∏–µ–Ω—Ç –ù–ï –º–µ–Ω—è–µ—Ç –∫–æ–¥ –Ω–∞ —Å–≤–æ—ë–º —Å–∞–π—Ç–µ.

**API endpoints –¥–ª—è Smart Widget (AI —á–∞—Ç):**
- –ö–æ–Ω—Ñ–∏–≥: `GET /api/v1/embed/{embed_key}` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `{ type: 'ai_chat', config: {...} }`
- –°–æ–±—ã—Ç–∏—è: `POST /api/v1/embed/events` ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç view/interaction
- **–ß–∞—Ç —Å AI:** –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint `POST /api/v1/chat/message` ‚Äî —ç—Ç–æ —Ç–æ—á–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Python backend –ò–ª—å–∏
  - Floqly Next.js –≤—ã—Å—Ç—É–ø–∞–µ—Ç –ø—Ä–æ–∫—Å–∏: –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ—Ç –≤–∏–¥–∂–µ—Ç–∞ ‚Üí –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Python —Å–µ—Ä–≤–∏—Å –ò–ª—å–∏ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç
  - –§–æ—Ä–º–∞—Ç: `{ widget_id, conversation_id, message, visitor_id }` ‚Üí Python AI ‚Üí `{ response, metadata }`
  - WebSocket –∏–ª–∏ SSE –¥–ª—è streaming –æ—Ç–≤–µ—Ç–æ–≤ (–∫–æ–≥–¥–∞ AI "–ø–µ—á–∞—Ç–∞–µ—Ç")

**–ï—Å–ª–∏ –ò–ª—å—è –∑–∞—Ö–æ—á–µ—Ç –æ–¥–∏–Ω –∫–æ–¥ –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:**
- –ü–æ–º–µ–Ω—è—Ç—å 2 —Ñ–∞–π–ª–∞ (main.ts + –¥–æ–±–∞–≤–∏—Ç—å endpoint) ‚Äî –æ—Å—Ç–∞–ª—å–Ω–æ–µ –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ
- –ú–æ–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: `data-widget-id` per-widget –∏ `data-project-id` all-in-one

**–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ —Å Supabase –Ω–∞ –¥—Ä—É–≥—É—é –ë–î:**
- –í–µ—Å—å –∫–æ–¥ —Ä–∞–±–æ—Ç—ã —Å –ë–î –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –≤ `lib/services/embed-service.ts`
- –ü—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Ñ–∞–π–ª + auth layer
- API endpoints –∏ –≤–∏–¥–∂–µ—Ç-—Å–∫—Ä–∏–ø—Ç –ù–ï –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç—Å—è

### 7. –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–¥–ª—è Claude –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å–µ—Å—Å–∏–∏) —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤:
**`C:\Users\User\.claude\plans\misty-sparking-gem.md`**

–≠—Ç–æ —Ñ–∞–π–ª –≤ —Å–∏—Å—Ç–µ–º–µ Claude Code, –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π —Å–µ—Å—Å–∏–∏.
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∫–æ–ø–∏—è –±—É–¥–µ—Ç –≤ –ø—Ä–æ–µ–∫—Ç–µ: `docs/plans/PLAN-embed-system.md`

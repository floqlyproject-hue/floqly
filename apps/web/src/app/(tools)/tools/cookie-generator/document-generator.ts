import type { CookieConfig, DocumentTone } from './types'

function t(tone: DocumentTone, legal: string, friendly: string, minimal: string): string {
  if (tone === 'legal') return legal
  if (tone === 'friendly') return friendly
  return minimal
}

export function generateCookieDocument(config: CookieConfig): string {
  const { company, cookieTypes, documentSettings } = config
  const { tone, businessScenario, analyticsTools, marketing, customAnalytics } = documentSettings

  const companyName = company.name || 'Оператор'
  const website = company.website || 'example.com'
  const date = new Date().toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })

  const enabledAnalytics = analyticsTools.filter((a) => a.enabled)
  const hasCrossBorder = enabledAnalytics.some((a) => a.isCrossBorder)
  const hasMarketing = marketing.showAds || marketing.retargeting

  const sections: string[] = []

  // 1. Header
  sections.push(
    t(
      tone,
      `## Политика использования файлов cookie\n\n**${companyName}** (${website})\nДата: ${date}\n\nНастоящая Политика разработана в соответствии с Федеральным законом от 27.07.2006 №152-ФЗ «О персональных данных» и определяет порядок обработки файлов cookie при использовании сайта ${website}.`,
      `## Политика использования файлов cookie\n\n**${companyName}** — ${website}\nОбновлено: ${date}\n\nМы заботимся о вашей конфиденциальности. Эта страница объясняет, какие файлы cookie мы используем и зачем.`,
      `## Политика cookie\n\n${companyName} · ${website} · ${date}`
    )
  )

  // 2. What are cookies
  sections.push(
    t(
      tone,
      `### Что такое файлы cookie\n\nФайлы cookie (куки) — это небольшие текстовые файлы, которые веб-сайт сохраняет на устройстве пользователя (компьютере, смартфоне, планшете) посредством веб-браузера. Cookie позволяют сайту запоминать информацию о сессии, предпочтениях и действиях пользователя в соответствии со ст. 5 Федерального закона №152-ФЗ.`,
      `### Что такое cookie?\n\nCookie — это маленькие файлы, которые сохраняются на вашем устройстве, когда вы посещаете наш сайт. Они помогают нам запоминать ваши предпочтения и делать сайт удобнее для вас.`,
      `### Что такое cookie\n\nCookie — текстовые файлы, сохраняемые на вашем устройстве для работы сайта.`
    )
  )

  // 3. What cookies we use
  const enabledTypes = cookieTypes.filter((c) => c.enabled)
  if (enabledTypes.length > 0) {
    let cookieSection = t(
      tone,
      '### Категории обрабатываемых файлов cookie\n\nОператор использует следующие категории файлов cookie:\n',
      '### Какие cookie мы используем\n\nВот типы cookie, которые работают на нашем сайте:\n',
      '### Типы cookie\n'
    )

    enabledTypes.forEach((ct) => {
      const reqLabel = ct.required
        ? t(tone, ' *(обязательные, ст. 6 ч. 1 п. 5 152-ФЗ)*', ' *(всегда включены)*', ' *(обяз.)*')
        : ''
      cookieSection += `\n**${ct.name}**${reqLabel}\n${ct.description}\n`
    })

    sections.push(cookieSection)
  }

  // 4. Technical cookies (ecommerce / auth)
  if (businessScenario.ecommerce || businessScenario.authService) {
    let techSection = t(
      tone,
      '### Технические файлы cookie\n\nДля обеспечения функционирования сервиса Оператор использует технические cookie:',
      '### Технические cookie\n\nДля корректной работы сервиса мы используем технические cookie:',
      '### Технические cookie'
    )

    if (businessScenario.ecommerce) {
      techSection += t(
        tone,
        '\n\n- **Корзина и заказы** — сохранение состояния корзины, выбранных товаров, данных доставки. Срок хранения: до завершения сессии или 30 дней.\n- **Токены авторизации** — обеспечение безопасного доступа к учётной записи (session_id, csrf_token).',
        '\n\n- **Корзина** — чтобы ваши товары не пропали при переходе между страницами\n- **Сессия** — чтобы вам не приходилось заново вводить данные при каждом действии',
        '\n\nКорзина, сессия, токены авторизации.'
      )
    }

    if (businessScenario.authService) {
      techSection += t(
        tone,
        '\n\n- **Авторизация** — cookie для поддержания сессии авторизованного пользователя, хранения JWT-токенов и refresh-токенов. Срок хранения: до выхода из системы или истечения срока действия токена.',
        '\n\n- **Авторизация** — чтобы вы оставались в своём аккаунте и вам не нужно было входить заново каждый раз',
        '\n\nCookie авторизации и сессии.'
      )
    }

    sections.push(techSection)
  }

  // 5. Payment cookies
  if (businessScenario.paidContent) {
    sections.push(
      t(
        tone,
        '### Cookie платёжных систем\n\nПри осуществлении платежей на сайте могут устанавливаться cookie платёжных шлюзов (YooKassa, CloudPayments и др.) для обеспечения безопасности транзакций в соответствии со стандартом PCI DSS. Данные cookie необходимы для:\n\n- Идентификации платёжной сессии\n- Предотвращения мошеннических операций\n- Подтверждения 3D-Secure\n\nОператор не имеет доступа к платёжным данным, обрабатываемым сторонними сервисами.',
        '### Cookie платёжных систем\n\nКогда вы совершаете покупку, платёжные сервисы (например, YooKassa) могут устанавливать свои cookie для безопасного проведения оплаты. Мы не видим и не храним данные вашей карты — этим занимается платёжный шлюз.',
        '### Платёжные cookie\n\nПлатёжные шлюзы используют собственные cookie для безопасности транзакций (PCI DSS).'
      )
    )
  }

  // 6. Analytics
  if (enabledAnalytics.length > 0 || customAnalytics) {
    let analyticsSection = t(
      tone,
      '### Системы аналитики\n\nОператор использует следующие системы веб-аналитики для сбора статистических данных о посещаемости сайта:',
      '### Аналитика\n\nМы используем сервисы аналитики, чтобы понимать, как вы пользуетесь сайтом, и улучшать его:',
      '### Аналитика'
    )

    enabledAnalytics.forEach((tool) => {
      const crossBorderNote = tool.isCrossBorder
        ? t(
            tone,
            ` — данные передаются на серверы в ${tool.country || 'зарубежные серверы'} (трансграничная передача, ст. 12 152-ФЗ)`,
            ` — обратите внимание: данные передаются в ${tool.country || 'другую страну'}`,
            ` (${tool.country || 'зарубежные серверы'})`
          )
        : t(tone, ` — обработка данных на территории РФ`, '', '')

      analyticsSection += `\n- **${tool.name}**${crossBorderNote}`
    })

    if (customAnalytics) {
      analyticsSection += `\n- **${customAnalytics}**`
    }

    sections.push(analyticsSection)
  }

  // 7. Cross-border data transfer
  if (hasCrossBorder) {
    sections.push(
      t(
        tone,
        `### Трансграничная передача данных\n\nВ соответствии со ст. 12 Федерального закона №152-ФЗ «О персональных данных», Оператор осуществляет трансграничную передачу персональных данных в следующие страны:\n\n${enabledAnalytics
          .filter((a) => a.isCrossBorder)
          .map((a) => `- **${a.country || 'Не указано'}** — ${a.name}`)
          .join('\n')}\n\nОснование для передачи: согласие субъекта персональных данных (ст. 12 ч. 4 152-ФЗ). Вы можете отозвать своё согласие в любое время через настройки cookie на сайте.\n\n> **Важно:** При использовании сервисов аналитики данные (IP-адрес, поведенческие характеристики, техническая информация об устройстве) могут обрабатываться на серверах, расположенных за пределами Российской Федерации.`,
        `### Передача данных за рубеж\n\nНекоторые сервисы, которые мы используем, хранят данные за пределами России:\n\n${enabledAnalytics
          .filter((a) => a.isCrossBorder)
          .map((a) => `- **${a.name}** — серверы в ${a.country || 'другой стране'}`)
          .join('\n')}\n\nЭто означает, что часть информации о вашем визите (например, какие страницы вы смотрели) может обрабатываться за рубежом. Вы можете отключить эти cookie в настройках баннера.`,
        `### Трансграничная передача\n\nДанные передаются за рубеж: ${enabledAnalytics
          .filter((a) => a.isCrossBorder)
          .map((a) => `${a.name} (${a.country})`)
          .join(', ')}. Основание — ваше согласие (ст. 12 152-ФЗ).`
      )
    )
  }

  // 8. Marketing
  if (hasMarketing) {
    let marketingSection = t(
      tone,
      '### Маркетинг и реклама\n\nОператор использует cookie для целей маркетинга и рекламы:',
      '### Реклама и маркетинг\n\nМы используем cookie для рекламных целей:',
      '### Маркетинг'
    )

    if (marketing.showAds) {
      marketingSection += t(
        tone,
        '\n\n- **Рекламные cookie** — используются для показа персонализированной рекламы на сайте посредством RTB-систем и баннерных сетей. Cookie позволяют определить интересы пользователя и показать релевантные рекламные материалы.',
        '\n\n- **Рекламные баннеры** — помогают показывать вам рекламу, которая может быть вам интересна, вместо случайных объявлений',
        '\n\nРекламные cookie для показа релевантной рекламы.'
      )
    }

    if (marketing.retargeting) {
      marketingSection += t(
        tone,
        '\n\n- **Ретаргетинг/Ремаркетинг** — cookie, позволяющие идентифицировать пользователя для показа рекламных объявлений на сторонних площадках. Осуществляется профилирование пользователя в соответствии со ст. 5 152-ФЗ.',
        '\n\n- **Ретаргетинг** — после посещения нашего сайта вы можете видеть нашу рекламу на других сайтах. Это помогает нам напомнить о себе',
        '\n\nРетаргетинг на сторонних площадках.'
      )
    }

    sections.push(marketingSection)
  }

  // 9. User rights
  sections.push(
    t(
      tone,
      `### Ваши права\n\nВ соответствии с Федеральным законом №152-ФЗ «О персональных данных» вы имеете право:\n\n- **Получить информацию** о том, какие cookie обрабатываются (ст. 14 152-ФЗ)\n- **Отозвать согласие** на обработку cookie в любое время\n- **Требовать удаления** обрабатываемых cookie (ст. 21 152-ФЗ)\n- **Обратиться в Роскомнадзор** в случае нарушения ваших прав`,
      `### Ваши права\n\nВы имеете полное право:\n\n- **Узнать**, какие cookie мы используем\n- **Отказаться** от необязательных cookie в любой момент\n- **Удалить** все cookie через настройки вашего браузера\n- **Пожаловаться** в Роскомнадзор, если считаете, что ваши права нарушены`,
      `### Ваши права\n\nВы можете отозвать согласие, удалить cookie или обратиться в Роскомнадзор (ст. 14, 21 152-ФЗ).`
    )
  )

  // 10. Managing cookies
  sections.push(
    t(
      tone,
      '### Управление файлами cookie\n\nВы можете управлять предпочтениями в отношении файлов cookie следующими способами:\n\n1. **Через баннер cookie** — нажмите кнопку «Настройки» при первом посещении сайта\n2. **Через настройки браузера** — в разделе «Конфиденциальность» вашего браузера\n3. **Через кнопку на сайте** — кнопка управления cookie доступна в нижней части каждой страницы\n\nОбратите внимание: отключение некоторых типов cookie может повлиять на функциональность сайта.',
      '### Как управлять cookie\n\nУ вас есть несколько способов:\n\n- **Баннер на сайте** — нажмите «Настройки» и выберите, какие cookie разрешить\n- **Настройки браузера** — найдите раздел «Конфиденциальность» или «Cookie»\n- **Кнопка внизу страницы** — вы всегда можете изменить свой выбор\n\nЕсли отключить все cookie, некоторые функции сайта могут работать не так, как обычно.',
      '### Управление cookie\n\nИспользуйте баннер cookie или настройки браузера для управления предпочтениями.'
    )
  )

  // 11. Contacts
  if (company.email) {
    sections.push(
      t(
        tone,
        `### Контакты\n\nПо вопросам обработки файлов cookie и персональных данных вы можете обратиться к Оператору:\n\n- **Email:** ${company.email}\n- **Организация:** ${companyName}`,
        `### Контакты\n\nЕсли у вас есть вопросы о cookie или конфиденциальности, напишите нам: **${company.email}**`,
        `### Контакты\n\n${company.email}`
      )
    )
  }

  // 12. Privacy policy link
  if (company.privacyPolicyUrl) {
    sections.push(
      t(
        tone,
        `### Политика конфиденциальности\n\nПолная Политика конфиденциальности Оператора доступна по ссылке: [${company.privacyPolicyUrl}](${company.privacyPolicyUrl})`,
        `### Подробнее\n\nПолная политика конфиденциальности: [перейти по ссылке](${company.privacyPolicyUrl})`,
        `[Политика конфиденциальности](${company.privacyPolicyUrl})`
      )
    )
  }

  return sections.join('\n\n---\n\n')
}
